<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>约饭报名</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; margin: 24px; }
    h1 { color: #e91e63; margin-bottom: 8px; }
    iframe { border: none; width: 100%; height: 600px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: #fafafa; position: sticky; top: 0; }
  </style>
</head>
<body>
  <h1>🍜 约饭报名 Beta v0.0.2版</h1>

  <!-- 1) Google Form -->
  <h2>填写报名表</h2>
  <iframe
    src="https://docs.google.com/forms/d/e/1FAIpQLSd7ZIaZY3jlKepyQcsks99s9GZoZwtC813_PMQiHvoyVb9AFQ/viewform?embedded=true">
  </iframe>

  <!-- 2) Results -->
  <h2>当前报名情况</h2>
  <table id="signup-table">
    <thead><tr id="signup-head"></tr></thead>
    <tbody id="signup-body"></tbody>
  </table>

  <script>
    // ✦✦✦ Set these to your Sheet info ✦✦✦
    const SHEET_ID   = "1hHyebhKYPIfgjD9qPOS5h0iJp3ey8hQA6hVc6dBhzyI";
    const SHEET_NAME = "default";

    const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq` +
                     `?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}&tq=${encodeURIComponent("select *")}`;

    async function loadData() {
      const head = document.getElementById("signup-head");
      const body = document.getElementById("signup-body");
      head.innerHTML = "<th>加载中……</th>";
      body.innerHTML = "";

      const resp = await fetch(GVIZ_URL);
      const txt  = await resp.text();

      const json = JSON.parse(txt.substring(txt.indexOf("{"), txt.lastIndexOf("}") + 1));

      // 表头
      const cols = json.table.cols.map(c => c.label || "").filter(Boolean);
      head.innerHTML = cols.map(h => `<th>${h}</th>`).join("");

      // 数据行
      const rows = json.table.rows.map(r => r.c.map(c => (c && (c.f ?? c.v)) ?? ""));
      rows.sort((a, b) => new Date(b[0]) - new Date(a[0])); // sort by timestamp desc

      body.innerHTML = rows.map(r =>
        `<tr>${
          r.map(v => {
            let val = String(v).trim();
            if (/^https?:\/\//i.test(val)) {
              return `<td><a href="${val}" target="_blank" rel="noopener noreferrer">${val}</a></td>`;
            } else {
              return `<td>${val.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</td>`;
            }
          }).join("")
        }</tr>`
      ).join("");
    }

    loadData();
    setInterval(loadData, 30000);
  </script>
</body>
</html>
